@page "/account"
@rendermode InteractiveServer
@using Cartridge.Web.Components.Layout
@using Cartridge.Core.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@using Cartridge.Infrastructure.Services
@layout RetroLayout
@attribute [Authorize]
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Account Settings - CARTRIDGE</PageTitle>

<div style="max-width: 800px; margin: 0 auto; padding: 40px 20px;">
    <div style="text-align: center; margin-bottom: 40px;">
        <h2 style="color: var(--retro-primary); font-size: 32px; text-transform: uppercase; margin-bottom: 20px;">
            ‚öôÔ∏è Account Settings
        </h2>
    </div>

    @if (isLoading)
    {
        <div class="loading-spinner"></div>
    }
    else if (currentUser != null)
    {
        <div class="filter-section" style="margin-bottom: 30px;">
            <h3 class="filter-title">üë§ Profile Information</h3>
            <div style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="color: var(--retro-text-dim); font-size: 11px; display: block; margin-bottom: 5px;">EMAIL:</label>
                    <div style="color: var(--retro-text); font-size: 14px; padding: 10px; background: var(--retro-bg-secondary); border: 2px solid var(--retro-border); border-radius: 4px;">
                        @currentUser.Email
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="color: var(--retro-text-dim); font-size: 11px; display: block; margin-bottom: 5px;">DISPLAY NAME:</label>
                    <div style="color: var(--retro-text); font-size: 14px; padding: 10px; background: var(--retro-bg-secondary); border: 2px solid var(--retro-border); border-radius: 4px;">
                        @currentUser.DisplayName
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="color: var(--retro-text-dim); font-size: 11px; display: block; margin-bottom: 5px;">MEMBER SINCE:</label>
                    <div style="color: var(--retro-text); font-size: 14px; padding: 10px; background: var(--retro-bg-secondary); border: 2px solid var(--retro-border); border-radius: 4px;">
                        @currentUser.CreatedAt.ToString("MMMM dd, yyyy")
                    </div>
                </div>
                @if (currentUser.LastLoginAt.HasValue)
                {
                    <div style="margin-bottom: 15px;">
                        <label style="color: var(--retro-text-dim); font-size: 11px; display: block; margin-bottom: 5px;">LAST LOGIN:</label>
                        <div style="color: var(--retro-text); font-size: 14px; padding: 10px; background: var(--retro-bg-secondary); border: 2px solid var(--retro-border); border-radius: 4px;">
                            @currentUser.LastLoginAt.Value.ToString("MMMM dd, yyyy HH:mm")
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="filter-section" style="margin-bottom: 30px;">
            <h3 class="filter-title">üîê Security</h3>
            <div style="padding: 20px;">
                @if (twoFactorStatus == null)
                {
                    <div class="loading-spinner"></div>
                }
                else
                {
                    <div style="margin-bottom: 20px;">
                        <label style="color: var(--retro-text-dim); font-size: 11px; display: block; margin-bottom: 10px;">TWO-FACTOR AUTHENTICATION:</label>
                        <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--retro-bg-secondary); border: 2px solid var(--retro-border); border-radius: 4px;">
                            @if (twoFactorStatus.IsEnabled)
                            {
                                <span style="color: var(--retro-success); font-size: 14px; font-weight: bold;">‚úÖ ENABLED</span>
                                <button class="btn-retro btn-retro-secondary" style="font-size: 9px; padding: 8px 12px;" @onclick="DisableTwoFactor" disabled="@isProcessing2FA">
                                    @if (isProcessing2FA)
                                    {
                                        <span>‚è≥ Processing...</span>
                                    }
                                    else
                                    {
                                        <span>DISABLE</span>
                                    }
                                </button>
                            }
                            else
                            {
                                <span style="color: var(--retro-text-dim); font-size: 14px;">‚ùå DISABLED</span>
                                <a href="/account/2fa-setup" class="btn-retro" style="font-size: 9px; padding: 8px 12px; text-decoration: none;">
                                    ENABLE 2FA
                                </a>
                            }
                        </div>
                        
                        @if (twoFactorStatus.IsEnabled)
                        {
                            <p style="color: var(--retro-text-dim); font-size: 9px; margin-top: 12px; line-height: 1.8;">
                                Your account is protected with two-factor authentication. You'll need to enter a code from your authenticator app when signing in.
                            </p>
                            
                            @if (twoFactorStatus.RecoveryCodesLeft > 0)
                            {
                                <p style="color: var(--retro-text-dim); font-size: 9px; margin-top: 8px;">
                                    Recovery codes remaining: <strong style="color: var(--retro-text);">@twoFactorStatus.RecoveryCodesLeft</strong>
                                </p>
                            }
                            else
                            {
                                <p style="color: var(--retro-warning); font-size: 9px; margin-top: 8px;">
                                    ‚ö†Ô∏è You have no recovery codes remaining. Consider generating new ones.
                                </p>
                            }
                        }
                        else
                        {
                            <p style="color: var(--retro-text-dim); font-size: 9px; margin-top: 12px; line-height: 1.8;">
                                Add an extra layer of security to your account by requiring a verification code when signing in.
                            </p>
                        }
                    </div>
                    
                    @if (!string.IsNullOrEmpty(securityMessage))
                    {
                        <div style="background: var(--retro-success); color: white; padding: 15px; margin-top: 15px; border: 3px solid darkgreen; font-size: 10px; line-height: 1.8;">
                            ‚úÖ @securityMessage
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(securityError))
                    {
                        <div style="background: var(--retro-error); color: white; padding: 15px; margin-top: 15px; border: 3px solid darkred; font-size: 10px; line-height: 1.8;">
                            ‚ö†Ô∏è @securityError
                        </div>
                    }
                }
            </div>
        </div>

        <div class="filter-section" style="border-color: var(--retro-error);">
            <h3 class="filter-title" style="color: var(--retro-error);">‚ö†Ô∏è Danger Zone</h3>
            <div style="padding: 20px;">
                @if (!showDeleteConfirmation)
                {
                    <p style="color: var(--retro-text); margin-bottom: 20px; line-height: 1.6;">
                        Deleting your account is permanent and cannot be undone. This will:
                    </p>
                    <ul style="color: var(--retro-text); margin-bottom: 20px; line-height: 1.8; padding-left: 20px;">
                        <li>Delete all your saved games from the library</li>
                        <li>Remove all platform connections</li>
                        <li>Delete your account information</li>
                        <li>Sign you out immediately</li>
                    </ul>
                    <button class="btn-retro" 
                            style="background: var(--retro-error); border-color: darkred;"
                            @onclick="ShowDeleteConfirmation">
                        üóëÔ∏è Delete My Account
                    </button>
                }
                else
                {
                    <div style="background: rgba(255, 107, 107, 0.1); border: 2px solid var(--retro-error); padding: 20px; margin-bottom: 20px; border-radius: 4px;">
                        <h4 style="color: var(--retro-error); font-size: 16px; margin-bottom: 15px; text-transform: uppercase;">
                            ‚ö†Ô∏è Are you absolutely sure?
                        </h4>
                        <p style="color: var(--retro-text); margin-bottom: 15px; line-height: 1.6;">
                            This action <strong>cannot be undone</strong>. This will permanently delete your account and remove all your data from our servers.
                        </p>
                        <p style="color: var(--retro-text); margin-bottom: 20px; line-height: 1.6;">
                            Please type <strong style="color: var(--retro-error);">DELETE</strong> to confirm:
                        </p>
                        <input type="text" 
                               @bind="deleteConfirmationText"
                               placeholder="Type DELETE to confirm"
                               style="width: 100%; padding: 14px; background: var(--retro-bg); color: var(--retro-text); border: 3px solid var(--retro-error); font-family: 'Press Start 2P', monospace; font-size: 11px; margin-bottom: 20px; text-transform: uppercase;" />
                        
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div style="background: var(--retro-error); color: white; padding: 15px; margin-bottom: 20px; border: 4px solid darkred; font-size: 11px;">
                                ‚ö†Ô∏è @errorMessage
                            </div>
                        }

                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn-retro" 
                                    style="background: var(--retro-error); border-color: darkred;"
                                    @onclick="DeleteAccount"
                                    disabled="@isDeleting">
                                @if (isDeleting)
                                {
                                    <span>‚è≥ Deleting...</span>
                                }
                                else
                                {
                                    <span>üóëÔ∏è Yes, Delete My Account</span>
                                }
                            </button>
                            <button class="btn-retro btn-retro-secondary" 
                                    @onclick="CancelDelete"
                                    disabled="@isDeleting">
                                ‚ùå Cancel
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <a href="/library" style="color: var(--retro-text-dim); font-size: 11px; text-decoration: none;">‚Üê Back to Library</a>
        </div>
    }
</div>

@code {
    private ApplicationUser? currentUser;
    private TwoFactorStatusResponse? twoFactorStatus;
    private bool showDeleteConfirmation = false;
    private bool isDeleting = false;
    private bool isProcessing2FA = false;
    private string deleteConfirmationText = "";
    private string? errorMessage;
    private string? securityMessage;
    private string? securityError;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            await LoadUserAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && currentUser != null)
        {
            await LoadTwoFactorStatusAsync();
            StateHasChanged();
        }
    }

    private async Task LoadUserAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                currentUser = await UserManager.FindByIdAsync(userId);
            }
        }
    }

    private async Task LoadTwoFactorStatusAsync()
    {
        try
        {
            if (currentUser == null)
                return;

            var hasAuthenticator = await UserManager.GetAuthenticatorKeyAsync(currentUser);
            var is2faEnabled = await UserManager.GetTwoFactorEnabledAsync(currentUser);
            var recoveryCodesLeft = await UserManager.CountRecoveryCodesAsync(currentUser);

            twoFactorStatus = new TwoFactorStatusResponse
            {
                IsEnabled = is2faEnabled && !string.IsNullOrEmpty(hasAuthenticator),
                IsMachineRemembered = false, // Skip this to avoid HttpContext issues
                RecoveryCodesLeft = recoveryCodesLeft
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading 2FA status: {ex.Message}");
            twoFactorStatus = new TwoFactorStatusResponse
            {
                IsEnabled = false,
                IsMachineRemembered = false,
                RecoveryCodesLeft = 0
            };
        }
    }

    private async Task DisableTwoFactor()
    {
        isProcessing2FA = true;
        securityError = null;
        securityMessage = null;
        StateHasChanged();

        try
        {
            var result = await AuthService.DisableTwoFactorAsync();
            
            if (result.Success)
            {
                securityMessage = "Two-factor authentication has been disabled.";
                await LoadTwoFactorStatusAsync();
            }
            else
            {
                securityError = result.Message ?? "Failed to disable two-factor authentication.";
            }
        }
        catch (Exception ex)
        {
            securityError = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isProcessing2FA = false;
            StateHasChanged();
        }
    }

    private void ShowDeleteConfirmation()
    {
        showDeleteConfirmation = true;
        deleteConfirmationText = "";
        errorMessage = null;
    }

    private void CancelDelete()
    {
        showDeleteConfirmation = false;
        deleteConfirmationText = "";
        errorMessage = null;
    }

    private async Task DeleteAccount()
    {
        if (deleteConfirmationText.Trim().ToUpper() != "DELETE")
        {
            errorMessage = "Please type DELETE to confirm account deletion.";
            return;
        }

        if (currentUser == null)
        {
            errorMessage = "User not found.";
            return;
        }

        isDeleting = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            // Delete the user account (this will cascade delete games and connections due to foreign keys)
            var result = await UserManager.DeleteAsync(currentUser);
            
            if (result.Succeeded)
            {
                // Sign out the user
                await SignInManager.SignOutAsync();
                
                // Redirect to home page
                Navigation.NavigateTo("/", forceLoad: true);
            }
            else
            {
                errorMessage = "Failed to delete account: " + string.Join(", ", result.Errors.Select(e => e.Description));
                isDeleting = false;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
            isDeleting = false;
            StateHasChanged();
        }
    }
}
